# 저격 홀덤 게임 개선 체크리스트 (Phase 2)

## 🚨 High Priority (우선 수정 필요)

### 1. ✅ **저격 시스템 완전 재구현** (족보 저격 방식으로 수정 완료)
- [x] **족보 저격 시스템 구현**
  - [x] 저격 대상을 "플레이어"가 아닌 "족보"로 변경
  - [x] SnipeModal UI에서 대상 선택 제거, 족보만 선택
  - [x] declare_snipe RPC 함수 족보 저격 방식으로 수정
  - [x] 저격 로그 메시지 "족보 저격" 형태로 변경

- [ ] **저격 결과 처리 로직**
  - [x] process_snipe_results 함수 생성 (SQL 파일)
  - [ ] 저격당한 족보 최하위 처리 로직
  - [ ] 저격 성공/실패 판정 로직 정교화
  - [ ] 여러 플레이어 동시 저격 지원

- [x] **저격 보상/페널티 시스템**
  - [x] 저격 성공 시 보상 칩 계산 로직
  - [x] 저격 실패 시 페널티 칩 차감 로직
  - [x] 저격 보상 상수 정의 (`SNIPE_SUCCESS_REWARD`, `SNIPE_FAILURE_PENALTY`)

### 2. 족보 시스템 보완
- [x] **플러시(Flush) 족보 추가**
  - [x] `handEvaluator.ts`에 플러시 감지 함수 구현
  - [x] 플러시 우선순위 설정 (풀하우스 < 플러시 < 스트레이트)
  - [x] 플러시 족보 UI 표시

- [x] **스트레이트 플러시 족보 추가**
  - [x] 스트레이트 플러시 감지 함수 구현
  - [x] 가장 높은 족보로 우선순위 설정
  - [x] 로얄 플러시(10-J-Q-K-A) 고려 여부 결정

- [x] **족보 우선순위 재정렬**
  - [x] `HandRank` 타입 업데이트
  - [x] 족보 비교 로직 수정
  - [x] UI에서 족보 순서 업데이트

## 🔶 Medium Priority (다음 단계 개선)

### 3. 게임 플로우 정교화
- [x] **저격 타이밍 명확화**
  - [x] 저격 페이즈를 별도 게임 상태로 관리
  - [x] 저격 단계 UI 상태 표시
  - [ ] 모든 플레이어가 저격 선언/패스 완료 후 다음 단계 진행

- [ ] **턴 순서 관리**
  - [ ] 저격 선언 순서 정의 (딜러부터 시계방향)
  - [ ] 저격 시간 제한 설정
  - [ ] 자동 패스 기능 구현

- [x] **베팅 시스템 개선**
  - [x] 베팅 한도 규칙 재검토 (가장 적은 칩 보유자 기준)
  - [x] 베팅 한도 UI 표시
  - [ ] 올인 상황 처리 로직
  - [ ] 사이드 팟(Side Pot) 구현 검토

### 4. UI/UX 개선
- [x] **게임 진행 상황 표시**
  - [x] 현재 게임 단계 명확한 UI 표시
  - [x] 저격 페이즈 진행 상황 표시
  - [ ] 대기 중인 플레이어 표시

- [x] **저격 상황 시각화**
  - [x] 저격 페이즈에서만 저격 버튼 표시
  - [ ] 저격 선언 현황 실시간 표시
  - [ ] 저격 대상-저격자 관계 시각적 표현
  - [ ] 저격 결과 애니메이션

- [ ] **족보 도우미 기능**
  - [ ] 현재 카드로 가능한 족보 힌트 표시
  - [ ] 저격 성공 확률 계산기 (선택사항)
  - [ ] 족보 설명 모달

## 🔷 Low Priority (추후 고려)

### 5. 기술적 개선
- [ ] **실시간 동기화 강화**
  - [ ] 저격 선언 실시간 브로드캐스트
  - [ ] 네트워크 끊김 시 재연결 로직
  - [ ] 상태 불일치 감지 및 복구

- [ ] **에러 처리 강화**
  - [ ] 동시성 이슈 처리 (여러 플레이어 동시 액션)
  - [ ] 부정 행위 방지 시스템
  - [ ] 클라이언트-서버 데이터 검증

- [ ] **성능 최적화**
  - [ ] 게임 상태 업데이트 최적화
  - [ ] 불필요한 리렌더링 방지
  - [ ] 메모리 누수 방지

### 6. 추가 기능
- [ ] **게임 통계 시스템**
  - [ ] 플레이어별 승률 통계
  - [ ] 저격 성공률 통계
  - [ ] 게임 히스토리 저장

- [ ] **관전 모드**
  - [ ] 게임 중 참관자 입장 허용
  - [ ] 관전자 전용 UI
  - [ ] 채팅 기능

- [ ] **리플레이 기능**
  - [ ] 게임 진행 과정 저장
  - [ ] 리플레이 재생 UI
  - [ ] 중요 순간 하이라이트

## 🔧 데이터베이스 스키마 변경사항

### 새로운 테이블
- [ ] **`snipe_declarations` 테이블 생성**
  ```sql
  CREATE TABLE snipe_declarations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    game_id UUID REFERENCES games(id),
    sniper_player_id UUID REFERENCES players(id),
    target_player_id UUID REFERENCES players(id),
    declared_hand_rank TEXT NOT NULL,
    declared_highest_card INTEGER NOT NULL,
    is_successful BOOLEAN,
    created_at TIMESTAMP DEFAULT NOW()
  );
  ```

### 기존 테이블 수정
- [ ] **`players` 테이블 수정**
  - [ ] `declared_snipe` 컬럼 제거 (별도 테이블로 이동)
  - [ ] `snipe_rewards` 컬럼 추가 (저격 보상 칩)

- [ ] **`games` 테이블 수정**
  - [ ] `game_phase` 컬럼 추가 ('betting', 'sniping', 'showdown')
  - [ ] `snipe_deadline` 컬럼 추가 (저격 시간 제한)

## 🔍 조사 및 검증 필요사항

- [ ] **데블스 플랜 영상 재분석**
  - [ ] 정확한 저격 타이밍 확인
  - [ ] 저격 보상 시스템 파악
  - [ ] 카드 범위 확인 (1-10? 1-13?)

- [ ] **게임 밸런스 테스트**
  - [ ] 저격 보상/페널티 적절성 검증
  - [ ] 족보 확률 재계산
  - [ ] 게임 진행 시간 측정

- [ ] **사용자 테스트**
  - [ ] UI/UX 사용성 테스트
  - [ ] 저격 시스템 이해도 테스트
  - [ ] 게임 재미도 평가

## 📝 구현 순서 제안

### Week 1: 핵심 시스템 개선
1. 저격 시스템 다중 지원 구현
2. 족보 시스템 플러시 추가
3. 저격 대상 선택 UI 구현

### Week 2: 게임 플로우 개선
1. 저격 타이밍 명확화
2. 턴 순서 관리 개선
3. 저격 보상/페널티 시스템 구현

### Week 3: UI/UX 개선
1. 저격 상황 시각화
2. 게임 진행 상황 표시
3. 족보 도우미 기능

### Week 4: 테스트 및 최적화
1. 통합 테스트
2. 성능 최적화
3. 버그 수정 및 안정화

---

이 체크리스트는 plan2.md에서 제시한 개선사항들을 실행 가능한 작업 단위로 분해한 것입니다.
각 항목을 체크하면서 단계적으로 게임을 개선해 나갈 수 있습니다. 

## ✅ **실제 데블스 플랜 규칙 적용 완료**

### 족보 시스템 수정
- [x] **플러시, 스트레이트 플러시 제거** 
  - [x] HandRank 타입에서 제거
  - [x] handEvaluator.ts에서 관련 함수 제거
  - [x] HAND_RANKS_ORDER 순서 수정
  - [x] UI 컴포넌트에서 제거 (SnipeModal, GameLog)

### 게임 플로우 개선
- [x] **게임 페이즈 관리 시스템**
  - [x] Game 타입에 game_phase 필드 추가
  - [x] 페이즈별 UI 상태 관리
  - [x] 저격 페이즈에서만 저격 가능하도록 제한

### 베팅 시스템 개선  
- [x] **실제 규칙 적용**
  - [x] 가장 적은 칩 보유자 기준 베팅 한도
  - [x] calculateBettingLimit 함수 구현
  - [x] BettingControls에서 베팅 한도 적용
  - [x] 베팅 한도 UI 표시 